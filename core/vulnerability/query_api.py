#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ¼æ´æŸ¥è¯¢ API æ¥å£

æä¾›ç¨‹åºåŒ–çš„æ¼æ´æŸ¥è¯¢æ¥å£ï¼Œå°è£…ç»Ÿä¸€æ¼æ´æŸ¥è¯¢åŠŸèƒ½ã€‚

ä¸»è¦åŠŸèƒ½ï¼š
- CVE æ¼æ´ä¿¡æ¯æŸ¥è¯¢
- æ¼æ´æœç´¢
- è¿æ¥æµ‹è¯•
- ç»Ÿè®¡ä¿¡æ¯è·å–

ç¤ºä¾‹ï¼š
    >>> from core.vulnerability.query_api import VulnQueryAPI
    >>> api = VulnQueryAPI()
    >>> result = api.query_cve("CVE-2021-44228")
    >>> print(result["formatted_info"])
"""

from core.vulnerability.unified_query import UnifiedVulnQuery
from typing import Dict, Any, List, Optional
from infrastructure.logging_config import get_logger

# è®¾ç½®æ—¥å¿—
logger = get_logger(__name__)


class VulnQueryAPI:
    """
    æ¼æ´æŸ¥è¯¢ API æ¥å£ç±»
    
    æä¾›é«˜çº§çš„æ¼æ´æŸ¥è¯¢æ¥å£ï¼Œå°è£…ç»Ÿä¸€æ¼æ´æŸ¥è¯¢åŠŸèƒ½ã€‚
    æ”¯æŒä»£ç†é…ç½®ï¼Œé€‚ç”¨äºéœ€è¦ä»£ç†è®¿é—®çš„åœºæ™¯ã€‚
    """
    
    def __init__(
        self,
        proxy_host: Optional[str] = None,
        proxy_port: Optional[int] = None,
        proxy_username: Optional[str] = None,
        proxy_password: Optional[str] = None
    ) -> None:
        """
        åˆå§‹åŒ–APIæ¥å£
        
        Args:
            proxy_host: ä»£ç†æœåŠ¡å™¨åœ°å€
            proxy_port: ä»£ç†æœåŠ¡å™¨ç«¯å£
            proxy_username: ä»£ç†ç”¨æˆ·å
            proxy_password: ä»£ç†å¯†ç 
        """
        logger.info(f"åˆå§‹åŒ–æ¼æ´æŸ¥è¯¢API - ä»£ç†: {proxy_host}:{proxy_port}")
        self.unified_query = UnifiedVulnQuery(
            proxy_host=proxy_host,
            proxy_port=proxy_port,
            proxy_username=proxy_username,
            proxy_password=proxy_password
        )
        logger.info("ç»Ÿä¸€æ¼æ´æŸ¥è¯¢å™¨åˆå§‹åŒ–å®Œæˆ")
    
    def query_cve(self, cve_id: str) -> Dict[str, Any]:
        """
        æŸ¥è¯¢CVEæ¼æ´ä¿¡æ¯
        
        Args:
            cve_id: CVEç¼–å·
            
        Returns:
            æ¼æ´ä¿¡æ¯å­—å…¸
        """
        logger.info(f"å¼€å§‹æŸ¥è¯¢CVE: {cve_id}")
        try:
            result = self.unified_query.query_vulnerability(cve_id)
            logger.info(f"CVEæŸ¥è¯¢å®Œæˆ: {cve_id}, æˆåŠŸ: {result.get('success', False)}")
            return result
        except Exception as e:
            logger.error(f"CVEæŸ¥è¯¢å¼‚å¸¸: {cve_id}, é”™è¯¯: {str(e)}", exc_info=True)
            return {
                "success": False,
                "error": f"æŸ¥è¯¢å¼‚å¸¸: {str(e)}",
                "vuln_id": cve_id
            }
    
    def search_vulnerabilities(self, keyword: str, severity: Optional[str] = None, limit: int = 10) -> List[Dict[str, Any]]:
        """
        æœç´¢æ¼æ´ä¿¡æ¯
        
        Args:
            keyword: æœç´¢å…³é”®è¯
            severity: ä¸¥é‡ç¨‹åº¦ç­›é€‰
            limit: ç»“æœæ•°é‡é™åˆ¶
            
        Returns:
            æ¼æ´ä¿¡æ¯åˆ—è¡¨
        """
        return self.unified_query.search_vulnerabilities(keyword, severity, limit)
    
    def test_connections(self) -> Dict[str, bool]:
        """
        æµ‹è¯•æ‰€æœ‰è¿æ¥
        
        Returns:
            è¿æ¥æµ‹è¯•ç»“æœå­—å…¸
        """
        return self.unified_query.test_connections()
    
    def get_statistics(self) -> Dict[str, Any]:
        """
        è·å–ç»Ÿè®¡ä¿¡æ¯
        
        Returns:
            ç»Ÿè®¡ä¿¡æ¯å­—å…¸
        """
        return self.unified_query.get_statistics()
    
    def close(self) -> None:
        """
        å…³é—­è¿æ¥
        
        é‡Šæ”¾èµ„æºï¼Œå…³é—­æ‰€æœ‰ API å®¢æˆ·ç«¯è¿æ¥ã€‚
        """
        self.unified_query.close()


# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    # åˆ›å»ºAPIå®ä¾‹
    api = VulnQueryAPI("xxxx", 80, "xxxx", "proxy_password_xxxxxxx")
    
    try:
        # æµ‹è¯•è¿æ¥
        print("[TEST] æµ‹è¯•è¿æ¥...")
        connections = api.test_connections()
        print(f"è¿æ¥çŠ¶æ€: {connections}")
        
        # æŸ¥è¯¢CVE
        print("\n[QUERY] æŸ¥è¯¢CVE...")
        cve_result = api.query_cve("CVE-2021-44228")
        print(f"æŸ¥è¯¢ç»“æœ: {cve_result}")
        if cve_result["success"]:
            source = cve_result.get("source", "Unknown")
            print(f"[OK] CVEæŸ¥è¯¢æˆåŠŸ: {source}")
        else:
            print(f"[ERR] CVEæŸ¥è¯¢å¤±è´¥: {cve_result.get('error', 'Unknown error')}")
        
        # è·å–ç»Ÿè®¡ä¿¡æ¯
        print("\nğŸ“Š è·å–ç»Ÿè®¡ä¿¡æ¯...")
        stats = api.get_statistics()
        print(f"ç»Ÿè®¡ä¿¡æ¯: {stats}")
        
    except Exception as e:
        print(f"[ERR] å‘ç”Ÿé”™è¯¯: {e}")
    finally:
        api.close()
