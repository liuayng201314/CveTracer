#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ç»Ÿä¸€æ¼æ´æŸ¥è¯¢å·¥å…·

æ•´åˆ CVE æŸ¥è¯¢åŠŸèƒ½ï¼Œæä¾›å®Œæ•´çš„æ¼æ´æŸ¥è¯¢æ¥å£ã€‚

ä¸»è¦åŠŸèƒ½ï¼š
- CVE æ¼æ´è¯¦ç»†ä¿¡æ¯æŸ¥è¯¢
- æ¼æ´å…³é”®è¯æœç´¢
- è¿æ¥æµ‹è¯•å’Œç»Ÿè®¡ä¿¡æ¯

æ”¯æŒçš„æ•°æ®æºï¼š
- NVD (National Vulnerability Database)

å¯ä½œä¸ºå‘½ä»¤è¡Œå·¥å…·ä½¿ç”¨ï¼Œä¹Ÿå¯ä½œä¸ºæ¨¡å—å¯¼å…¥ä½¿ç”¨ã€‚

å‘½ä»¤è¡Œç¤ºä¾‹ï¼š
    python -m core.vulnerability.unified_query --cve CVE-2021-44228
    python -m core.vulnerability.unified_query --search "Apache" --limit 5

æ¨¡å—ä½¿ç”¨ç¤ºä¾‹ï¼š
    >>> from core.vulnerability.unified_query import UnifiedVulnQuery
    >>> query = UnifiedVulnQuery()
    >>> result = query.query_vulnerability("CVE-2021-44228")
"""

import sys
import argparse
import pathlib
import json
import os
from typing import Dict, Any, List, Optional

# è®¾ç½®ç¯å¢ƒå˜é‡ç¡®ä¿UTF-8ç¼–ç 
os.environ['PYTHONIOENCODING'] = 'utf-8'
from infrastructure.nvd.simple_api_client import SimpleVulnAPI
from infrastructure.logging_config import get_logger

# è®¾ç½®æ—¥å¿—
logger = get_logger(__name__)


class UnifiedVulnQuery:
    """
    ç»Ÿä¸€æ¼æ´æŸ¥è¯¢ç±»
    
    æ•´åˆå¤šä¸ªæ¼æ´æ•°æ®æºï¼Œæä¾›ç»Ÿä¸€çš„æ¼æ´æŸ¥è¯¢æ¥å£ã€‚
    æ”¯æŒä»£ç†é…ç½®ï¼Œé€‚ç”¨äºéœ€è¦ä»£ç†è®¿é—®çš„åœºæ™¯ã€‚
    """
    
    def __init__(
        self,
        proxy_host: Optional[str] = None,
        proxy_port: Optional[int] = None,
        proxy_username: Optional[str] = None,
        proxy_password: Optional[str] = None
    ) -> None:
        """
        åˆå§‹åŒ–ç»Ÿä¸€æŸ¥è¯¢å™¨
        
        Args:
            proxy_host: ä»£ç†æœåŠ¡å™¨åœ°å€
            proxy_port: ä»£ç†æœåŠ¡å™¨ç«¯å£
            proxy_username: ä»£ç†ç”¨æˆ·å
            proxy_password: ä»£ç†å¯†ç 
        """
        self.proxy_host = proxy_host
        self.proxy_port = proxy_port
        self.proxy_username = proxy_username
        self.proxy_password = proxy_password
        
        # åˆå§‹åŒ–APIå®¢æˆ·ç«¯
        self.cve_api = None
        
        self._initialize_clients()
    
    def _initialize_clients(self):
        """åˆå§‹åŒ–æ‰€æœ‰APIå®¢æˆ·ç«¯"""
        logger.info("å¼€å§‹åˆå§‹åŒ–APIå®¢æˆ·ç«¯")
        try:
            # åˆå§‹åŒ–CVEæŸ¥è¯¢API - NVDè¯·æ±‚éœ€è¦ä»£ç†
            logger.info("åˆå§‹åŒ–CVEæŸ¥è¯¢API")
            self.cve_api = SimpleVulnAPI(
                proxy_host=self.proxy_host,
                proxy_port=self.proxy_port,
                proxy_username=self.proxy_username,
                proxy_password=self.proxy_password
            )
            logger.info("CVEæŸ¥è¯¢APIåˆå§‹åŒ–æˆåŠŸ")
                
        except Exception as e:
            logger.error(f"åˆå§‹åŒ–APIå®¢æˆ·ç«¯å¤±è´¥: {e}", exc_info=True)
            raise RuntimeError(f"åˆå§‹åŒ–APIå®¢æˆ·ç«¯å¤±è´¥: {e}") from e
    
    def query_vulnerability(self, vuln_id: str) -> Dict[str, Any]:
        """
        æŸ¥è¯¢æ¼æ´è¯¦æƒ… - ä½¿ç”¨CVE APIæŸ¥è¯¢
        
        Args:
            vuln_id: æ¼æ´ID (CVE-xxx)
            
        Returns:
            æ¼æ´è¯¦æƒ…å­—å…¸
        """
        logger.info(f"å¼€å§‹æŸ¥è¯¢æ¼æ´: {vuln_id}")
        
        # ä½¿ç”¨CVE APIæŸ¥è¯¢
        try:
            logger.debug("å¼€å§‹ä½¿ç”¨CVE APIæŸ¥è¯¢")
            vuln_data = self.cve_api.get_cve_info(vuln_id)
            
            if not vuln_data.get('error'):
                logger.info("CVE APIæŸ¥è¯¢æˆåŠŸ")
                formatted_info = self.cve_api.format_vulnerability_info(vuln_data)
                result = {
                    "success": True,
                    "vuln_id": vuln_id,
                    "source": "CVE API",
                    "data": vuln_data,
                    "formatted_info": formatted_info
                }
                logger.info(f"æŸ¥è¯¢å®Œæˆ: {vuln_id}, æˆåŠŸ: True")
                return result
            else:
                error_msg = vuln_data.get('error', 'Unknown error')
                logger.warning(f"CVE APIæŸ¥è¯¢å¤±è´¥: {error_msg}")
                result = {
                    "success": False,
                    "vuln_id": vuln_id,
                    "source": "CVE API",
                    "error": error_msg
                }
                logger.info(f"æŸ¥è¯¢å®Œæˆ: {vuln_id}, æˆåŠŸ: False")
                return result
        except Exception as e:
            logger.error(f"CVE APIæŸ¥è¯¢å¼‚å¸¸: {e}", exc_info=True)
            result = {
                "success": False,
                "vuln_id": vuln_id,
                "source": "CVE API",
                "error": str(e)
            }
            logger.info(f"æŸ¥è¯¢å®Œæˆ: {vuln_id}, æˆåŠŸ: False")
            return result
    
    
    def search_vulnerabilities(self, keyword: str, severity: Optional[str] = None, limit: int = 10) -> List[Dict[str, Any]]:
        """
        æœç´¢æ¼æ´ä¿¡æ¯
        
        Args:
            keyword: æœç´¢å…³é”®è¯
            severity: ä¸¥é‡ç¨‹åº¦ç­›é€‰
            limit: ç»“æœæ•°é‡é™åˆ¶
            
        Returns:
            æ¼æ´ä¿¡æ¯åˆ—è¡¨
        """
        try:
            logger.info(f"æœç´¢æ¼æ´: keyword={keyword}, severity={severity}, limit={limit}")
            results = self.cve_api.search_vulnerabilities(keyword, severity, limit)
            logger.info(f"æœç´¢å®Œæˆï¼Œæ‰¾åˆ° {len(results)} æ¡ç»“æœ")
            return results
        except Exception as e:
            logger.error(f"æœç´¢æ¼æ´å¤±è´¥: {e}", exc_info=True)
            return []
    
    def test_connections(self) -> Dict[str, bool]:
        """
        æµ‹è¯•æ‰€æœ‰è¿æ¥
        
        Returns:
            è¿æ¥æµ‹è¯•ç»“æœå­—å…¸
        """
        results = {}
        
        # æµ‹è¯•CVE APIè¿æ¥
        try:
            results["cve_api"] = self.cve_api.test_connection()
        except:
            results["cve_api"] = False
        
        return results
    
    def get_statistics(self) -> Dict[str, Any]:
        """è·å–ç»Ÿè®¡ä¿¡æ¯"""
        try:
            return self.cve_api.get_statistics()
        except:
            return {
                'total_count': 0,
                'severity_distribution': {},
                'sources': {},
                'last_updated': 'N/A',
                'running_mode': 'unified'
            }
    
    def close(self) -> None:
        """
        å…³é—­æ‰€æœ‰è¿æ¥
        
        é‡Šæ”¾èµ„æºï¼Œå…³é—­æ‰€æœ‰ API å®¢æˆ·ç«¯è¿æ¥ã€‚
        """
        try:
            if self.cve_api:
                self.cve_api.close()
        except Exception as e:
            logger.warning(f"å…³é—­è¿æ¥æ—¶å‘ç”Ÿé”™è¯¯: {e}")


def display_cve_info(vuln_data):
    """æ˜¾ç¤ºCVEä¿¡æ¯"""
    if not vuln_data or vuln_data.get('error'):
        print("[ERR] æœªæ‰¾åˆ°è¯¥CVE")
        if vuln_data and vuln_data.get('error'):
            print(f"   é”™è¯¯: {vuln_data['error']}")
        return False
    
    print("[OK] æŸ¥è¯¢æˆåŠŸ")
    print("=" * 60)
    print("ğŸ“‹ æ¼æ´è¯¦ç»†ä¿¡æ¯")
    print("=" * 60)
    
    # åŸºæœ¬ä¿¡æ¯
    vuln_id = vuln_data.get('name', vuln_data.get('cve_id', 'N/A'))
    title = vuln_data.get('title', 'N/A')
    print(f"[INFO] æ¼æ´ID: {vuln_id}")
    print(f"[INFO] æ ‡é¢˜: {title}")
    
    # ä¸¥é‡ç¨‹åº¦å’Œè¯„åˆ†
    cvss3 = vuln_data.get('cvss3', {})
    severity = cvss3.get('severity', vuln_data.get('severity', 'N/A'))
    cvss_score = cvss3.get('baseScore', vuln_data.get('cvss_score', vuln_data.get('overallScore', 'N/A')))
    cvss_vector = cvss3.get('vector', 'N/A')
    
    severity_icon = {
        'CRITICAL': 'ğŸ”´',
        'HIGH': 'ğŸŸ ', 
        'MEDIUM': 'ğŸŸ¡',
        'LOW': 'ğŸŸ¢',
        'UNKNOWN': 'âšª'
    }.get(severity, 'âšª')
    
    print(f"{severity_icon} ä¸¥é‡ç¨‹åº¦: {severity}")
    print(f"ğŸ“Š CVSSè¯„åˆ†: {cvss_score}")
    if cvss_vector != 'N/A':
        print(f"ğŸ“ è¯„åˆ†å‘é‡: {cvss_vector}")
    
    # æ•°æ®æºä¿¡æ¯
    source = vuln_data.get('source', 'N/A')
    source_icon = {
        'NVD': '[US]',
        'CVE_DETAILS': '[LU]',
        'EXPLOIT_DB': '[EXP]',
        'CNVD': '[CN]'
    }.get(source, '[WEB]')
    
    print(f"{source_icon} æ•°æ®æº: {source}")
    
    # å‘å¸ƒæ—¶é—´
    publish_date = vuln_data.get('publishedDate', vuln_data.get('publish_date', 'N/A'))
    if publish_date != 'N/A':
        try:
            from datetime import datetime
            if 'T' in publish_date:
                dt = datetime.fromisoformat(publish_date.replace('Z', '+00:00'))
                formatted_date = dt.strftime('%Y-%m-%d %H:%M:%S')
            else:
                formatted_date = publish_date
        except:
            formatted_date = publish_date
    else:
        formatted_date = publish_date
    
    print(f"ğŸ“… å‘å¸ƒæ—¶é—´: {formatted_date}")
    
    # CWEä¿¡æ¯
    cwe_list = vuln_data.get('cwe', [])
    if cwe_list:
        print(f"ğŸ”§ æ¼æ´ç±»å‹: {', '.join(cwe_list)}")
    
    # CISAä¿¡æ¯
    cisa_info = vuln_data.get('cisa', {})
    if cisa_info:
        print(f"ğŸ›ï¸ CISAè¡ŒåŠ¨æœŸé™: {cisa_info.get('action_due', 'N/A')}")
        if cisa_info.get('required_action'):
            print(f"ğŸ“‹ CISAè¦æ±‚è¡ŒåŠ¨: {cisa_info['required_action'][:100]}{'...' if len(cisa_info['required_action']) > 100 else ''}")
    
    # æè¿°ä¿¡æ¯
    description = vuln_data.get('description', '')
    if description:
        print("\nğŸ“„ æ¼æ´æè¿°:")
        print("-" * 40)
        if len(description) > 300:
            words = description.split()
            lines = []
            current_line = ""
            for word in words:
                if len(current_line + " " + word) <= 80:
                    current_line += (" " + word) if current_line else word
                else:
                    if current_line:
                        lines.append(current_line)
                    current_line = word
            if current_line:
                lines.append(current_line)
            
            for line in lines[:8]:
                print(f"   {line}")
            if len(lines) > 8:
                print("   ...")
        else:
            print(f"   {description}")
    
    print("=" * 60)
    return True


def display_search_results(results, limit=5):
    """æ˜¾ç¤ºæœç´¢ç»“æœ"""
    if not results:
        print("[ERR] æœªæ‰¾åˆ°åŒ¹é…çš„æ¼æ´")
        return
    
    print(f"[OK] æ‰¾åˆ° {len(results)} æ¡ç»“æœ:")
    print("=" * 60)
    
    for i, vuln in enumerate(results[:limit], 1):
        cve_id = vuln.get('name', vuln.get('cve_id', 'N/A'))
        title = vuln.get('title', 'N/A')
        source = vuln.get('source', 'N/A')
        
        # è·å–CVSSä¿¡æ¯
        cvss3 = vuln.get('cvss3', {})
        severity = cvss3.get('severity', vuln.get('severity', 'N/A'))
        cvss_score = cvss3.get('baseScore', vuln.get('cvss_score', vuln.get('overallScore', 'N/A')))
        
        # ä¸¥é‡ç¨‹åº¦å›¾æ ‡
        severity_icon = {
            'CRITICAL': 'ğŸ”´',
            'HIGH': 'ğŸŸ ', 
            'MEDIUM': 'ğŸŸ¡',
            'LOW': 'ğŸŸ¢',
            'UNKNOWN': 'âšª'
        }.get(severity, 'âšª')
        
        # æ•°æ®æºå›¾æ ‡
        source_icon = {
            'NVD': '[US]',
            'CVE_DETAILS': '[LU]',
            'EXPLOIT_DB': '[EXP]',
            'CNVD': '[CN]'
        }.get(source, '[WEB]')
        
        # æˆªå–æ ‡é¢˜é•¿åº¦
        if len(title) > 45:
            title = title[:45] + "..."
        
        print(f"  {i:2d}. {cve_id}")
        print(f"      {severity_icon} {severity} | ğŸ“Š {cvss_score} | {source_icon} {source}")
        print(f"      [INFO] {title}")
        
        # æ˜¾ç¤ºCWEä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
        cwe_list = vuln.get('cwe', [])
        if cwe_list:
            cwe_display = ', '.join(cwe_list[:3])
            if len(cwe_list) > 3:
                cwe_display += f" (+{len(cwe_list)-3} more)"
            print(f"      ğŸ”§ {cwe_display}")
        
        print()
    
    if len(results) > limit:
        print(f"  ... è¿˜æœ‰ {len(results) - limit} æ¡ç»“æœ")
    print("=" * 60)


def display_statistics(stats):
    """æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯"""
    print("=" * 60)
    print("ğŸ“Š ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯")
    print("=" * 60)
    
    # æ€»æ¼æ´æ•°
    total_count = stats.get('total_count', 0)
    print(f"ğŸ”¢ æ€»æ¼æ´æ•°: {total_count}")
    
    # ä¸¥é‡ç¨‹åº¦åˆ†å¸ƒ
    severity_dist = stats.get('severity_distribution', {})
    if severity_dist:
        print("\nğŸ¯ ä¸¥é‡ç¨‹åº¦åˆ†å¸ƒ:")
        for severity, count in severity_dist.items():
            icon = {
                'CRITICAL': 'ğŸ”´',
                'HIGH': 'ğŸŸ ', 
                'MEDIUM': 'ğŸŸ¡',
                'LOW': 'ğŸŸ¢',
                'UNKNOWN': 'âšª'
            }.get(severity, 'âšª')
            print(f"   {icon} {severity}: {count} ä¸ª")
    
    # æ•°æ®æºåˆ†å¸ƒ
    sources = stats.get('sources', {})
    if sources:
        print("\n[WEB] æ•°æ®æºåˆ†å¸ƒ:")
        for source, count in sources.items():
            icon = {
                'NVD': '[US]',
                'CVE_DETAILS': '[LU]',
                'EXPLOIT_DB': '[EXP]',
                'CNVD': '[CN]'
            }.get(source, '[WEB]')
            print(f"   {icon} {source}: {count} ä¸ª")
    
    # å…¶ä»–ä¿¡æ¯
    print(f"\n[TIME] æœ€åæ›´æ–°: {stats.get('last_updated', 'N/A')}")
    print(f"ğŸ”§ è¿è¡Œæ¨¡å¼: {stats.get('running_mode', 'N/A')}")
    
    print("=" * 60)


def main():
    """ä¸»å‡½æ•° - ç»Ÿä¸€æ¼æ´æŸ¥è¯¢å·¥å…· v3.0"""
    parser = argparse.ArgumentParser(
        description='ç»Ÿä¸€æ¼æ´æŸ¥è¯¢å·¥å…· v3.0 - CVEæŸ¥è¯¢',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¤ºä¾‹ç”¨æ³•:

CVEç¼–å·æŸ¥è¯¢:
  python unified_vuln_query.py --cve CVE-2021-44228              # æŸ¥è¯¢ç‰¹å®šCVE
  python unified_vuln_query.py --search "Apache" --limit 5       # æœç´¢æ¼æ´
  python unified_vuln_query.py --search "SQL" --severity HIGH    # æŒ‰ä¸¥é‡ç¨‹åº¦æœç´¢

ä»£ç†é…ç½®:
  python unified_vuln_query.py --cve CVE-2021-44228 --proxy-host xxxx --proxy-port 80
  python unified_vuln_query.py --cve CVE-2021-44228 --proxy-host xxxx --proxy-port 80 --proxy-username xxxx --proxy-password xxxx
  python unified_vuln_query.py --test-proxy --proxy-host xxxx --proxy-port 80 --proxy-username xxxx --proxy-password xxxx

è¿æ¥æµ‹è¯•:
  python unified_vuln_query.py --test-connections              # æµ‹è¯•æ‰€æœ‰è¿æ¥
  python unified_vuln_query.py --test-proxy --proxy-host xxxx --proxy-port 80

æ”¯æŒçš„æ•°æ®æº:
  [US] NVD (National Vulnerability Database)
  [LU] CVE Details (CIRCL)
  [EXP] Exploit-DB (Offensive Security)
  [CN] CNVD (ä¸­å›½å›½å®¶ä¿¡æ¯å®‰å…¨æ¼æ´åº“)
        """
    )
    
    # CVEæŸ¥è¯¢å‚æ•°
    parser.add_argument('--cve', type=str, help='æŸ¥è¯¢ç‰¹å®šCVE ID')
    parser.add_argument('--search', type=str, help='æœç´¢å…³é”®è¯')
    parser.add_argument('--severity', type=str, 
                       choices=['CRITICAL', 'HIGH', 'MEDIUM', 'LOW'], 
                       help='ä¸¥é‡ç¨‹åº¦ç­›é€‰')
    parser.add_argument('--limit', type=int, default=10, 
                       help='ç»“æœæ•°é‡é™åˆ¶ (é»˜è®¤: 10)')
    
    # ç»Ÿè®¡ä¿¡æ¯
    parser.add_argument('--stats', action='store_true', 
                       help='æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯')
    
    # è¿æ¥æµ‹è¯•
    parser.add_argument('--test-connections', action='store_true',
                       help='æµ‹è¯•æ‰€æœ‰APIè¿æ¥')
    
    # ä»£ç†é…ç½®å‚æ•°
    parser.add_argument('--proxy-host', type=str, 
                       help='ä»£ç†æœåŠ¡å™¨åœ°å€ (ä¾‹å¦‚: xxxx)')
    parser.add_argument('--proxy-port', type=int, 
                       help='ä»£ç†æœåŠ¡å™¨ç«¯å£ (ä¾‹å¦‚: 80)')
    parser.add_argument('--proxy-username', type=str, 
                       help='ä»£ç†ç”¨æˆ·å')
    parser.add_argument('--proxy-password', type=str, 
                       help='ä»£ç†å¯†ç ')
    parser.add_argument('--test-proxy', action='store_true',
                       help='æµ‹è¯•ä»£ç†è¿æ¥')
    
    args = parser.parse_args()
    
    print("=" * 60)
    print("[INFO] ç»Ÿä¸€æ¼æ´æŸ¥è¯¢å·¥å…· v3.0")
    print("=" * 60)
    print("[WEB] CVEæŸ¥è¯¢")
    print("=" * 60)
    
    # åˆå§‹åŒ–ç»Ÿä¸€æŸ¥è¯¢å™¨
    try:
        # é…ç½®ä»£ç†å‚æ•°
        proxy_host = args.proxy_host
        proxy_port = args.proxy_port
        proxy_username = args.proxy_username
        proxy_password = args.proxy_password
        
        # å¦‚æœæä¾›äº†ä»£ç†é…ç½®ï¼Œæ˜¾ç¤ºä»£ç†ä¿¡æ¯
        if proxy_host and proxy_port:
            print(f"[WEB] é…ç½®ä»£ç†: {proxy_host}:{proxy_port}")
            if proxy_username:
                print(f"[AUTH] ä»£ç†è®¤è¯: {proxy_username}")
        
        unified_query = UnifiedVulnQuery(
            proxy_host=proxy_host,
            proxy_port=proxy_port,
            proxy_username=proxy_username,
            proxy_password=proxy_password
        )
        
        # å¦‚æœç”¨æˆ·è¦æ±‚æµ‹è¯•ä»£ç†è¿æ¥
        if args.test_proxy:
            print("\n[TEST] æµ‹è¯•ä»£ç†è¿æ¥...")
            if unified_query.cve_api.test_connection():
                print("[OK] ä»£ç†è¿æ¥æ­£å¸¸ï¼Œå¯ä»¥ç»§ç»­ä½¿ç”¨")
            else:
                print("[ERR] ä»£ç†è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»£ç†è®¾ç½®")
                sys.exit(1)
        
        # å¦‚æœç”¨æˆ·è¦æ±‚æµ‹è¯•æ‰€æœ‰è¿æ¥
        if args.test_connections:
            print("\n[TEST] æµ‹è¯•æ‰€æœ‰APIè¿æ¥...")
            results = unified_query.test_connections()
            
            print("\nğŸ“Š è¿æ¥æµ‹è¯•ç»“æœ:")
            print("-" * 40)
            for api, status in results.items():
                icon = "[OK]" if status else "[FAIL]"
                api_name = {
                    "cve_api": "CVE API"
                }.get(api, api)
                print(f"  {icon} {api_name}: {'æ­£å¸¸' if status else 'å¤±è´¥'}")
            
            if not any(results.values()):
                print("\n[ERR] æ‰€æœ‰APIè¿æ¥éƒ½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œå’Œé…ç½®")
                sys.exit(1)
            else:
                print("\n[OK] è‡³å°‘æœ‰ä¸€ä¸ªAPIè¿æ¥æ­£å¸¸")
                return
        
    except Exception as e:
        print(f"[ERR] åˆå§‹åŒ–ç»Ÿä¸€æŸ¥è¯¢å™¨å¤±è´¥: {e}")
        sys.exit(1)
    
    try:
        # CVEç¼–å·æŸ¥è¯¢
        if args.cve:
            print(f"\n[QUERY] æŸ¥è¯¢æ¼æ´: {args.cve}")
            result = unified_query.query_vulnerability(args.cve)
            
            if result["success"]:
                source = result.get("source", "Unknown")
                print(f"\n[OK] æŸ¥è¯¢æˆåŠŸ (æ•°æ®æº: {source})")
                
                print("\n" + "="*50)
                print(result["formatted_info"])
                print("="*50)
            else:
                print(f"\n[ERR] æŸ¥è¯¢å¤±è´¥: {result.get('error', 'Unknown error')}")
        
        # æœç´¢æ¼æ´
        elif args.search:
            print(f"\n[SEARCH] æœç´¢å…³é”®è¯: '{args.search}'")
            if args.severity:
                print(f"   ä¸¥é‡ç¨‹åº¦ç­›é€‰: {args.severity}")
            print(f"   ç»“æœé™åˆ¶: {args.limit}")
            
            results = unified_query.search_vulnerabilities(
                keyword=args.search,
                severity=args.severity,
                limit=args.limit
            )
            display_search_results(results, args.limit)
        
        # æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
        elif args.stats:
            print(f"\nğŸ“Š è·å–ç»Ÿè®¡ä¿¡æ¯...")
            stats = unified_query.get_statistics()
            display_statistics(stats)
        
        # å¦‚æœæ²¡æœ‰æŒ‡å®šä»»ä½•å‚æ•°ï¼Œæ˜¾ç¤ºå¸®åŠ©
        else:
            print("\nğŸ’¡ ä½¿ç”¨ --help æŸ¥çœ‹å¯ç”¨é€‰é¡¹")
            print("\nå¿«é€Ÿå¼€å§‹:")
            print("  # CVEæŸ¥è¯¢")
            print("  python unified_vuln_query.py --cve CVE-2021-44228")
            print("  python unified_vuln_query.py --search 'Apache' --limit 5")
            print("  # è¿æ¥æµ‹è¯•")
            print("  python unified_vuln_query.py --test-connections")
            print("  # ç»Ÿè®¡ä¿¡æ¯")
            print("  python unified_vuln_query.py --stats")
    
    except KeyboardInterrupt:
        print("\n\nâ¹ï¸  æ“ä½œå·²å–æ¶ˆ")
    except Exception as e:
        print(f"\n[ERR] å‘ç”Ÿé”™è¯¯: {e}")
        sys.exit(1)
    finally:
        # å…³é—­ç»Ÿä¸€æŸ¥è¯¢å™¨
        try:
            unified_query.close()
        except:
            pass


if __name__ == "__main__":
    main()
